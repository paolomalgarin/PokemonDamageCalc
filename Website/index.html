<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Damage Calculator</title>

    <link rel="shortcut icon" href="./public/img/logo-small.svg" type="image/x-icon">
    <link rel="stylesheet" href="./public/css/base-style.css">
    <link rel="stylesheet" href="./public/css/damagecalc/index.css">
</head>

<body>
    <main>
        <div class="settings"></div>
        <div class="calc_form">
            <div class="option-container">
                <div id="pkmn-container-1" class="pkmn-container"></div>
                <div id="field-options-container">
                    <button id="pkmn-number-option" onclick="updatePkmn(event)" value="1">Pkmn 1</button>
                    <button id="move-number-option" onclick="updateMove(event)" value="0">Move 1</button>
                    <div id="dmg"></div>
                </div>
                <div id="pkmn-container-2" class="pkmn-container"></div>
            </div>

            <!-- OPERAZIONI (Calcola reset ...) -->
            <div class="operations">
                <div class="btn" onclick="BTN_calc_damage()">CALC</div>
            </div>
        </div>
        </div>
    </main>

    <!-- Scripts -->
    <script src="./public/js/button_gui.js"></script>
    <script src="./public/js/calc_damage.js"></script>
    <script src="./public/js/damagecalc/type-chart.js"></script>
    <script src="./public/js/damagecalc/structure-maker.js"></script>
    <script src="./public/js/damagecalc/api-fetcher.js"></script>
    <script>
        const pkmnContainer1 = document.getElementById('pkmn-container-1');
        const pkmnContainer2 = document.getElementById('pkmn-container-2');

        createPkmnContainerStructure_GENERIC(pkmnContainer1, 'pkmn1', 'Pokemon 1', 'Abomasnow');
        createPkmnContainerStructure_GENERIC(pkmnContainer2, 'pkmn2', 'Pokemon 2', 'Abomasnow');

        const updatePkmn = (e) => {
            // console.log(e.target);
            if (e.target.value == 1) {
                e.target.value = 2;
                e.target.innerText = 'Pkmn 2';
            } else if (!e.target.value || e.target.value == 2) {
                e.target.value = 1;
                e.target.innerText = 'Pkmn 1';
            }
        }

        const updateMove = (e) => {
            // console.log(e.target);
            if (e.target.value < 3) {
                e.target.value = Number(e.target.value) + 1;
                e.target.innerText = 'Move ' + (Number(e.target.value) + 1);
            } else {
                e.target.value = 0;
                e.target.innerText = 'Move 1';
            }
        }

        const BTN_calc_damage = () => {
            let pkmnNumber = document.getElementById('pkmn-number-option').value;
            let defenderNumber = pkmnNumber == 1 ? 2 : 1;
            let moveNumber = document.getElementById('move-number-option').value;

            let attackerLvl = document.getElementById(`pkmn${pkmnNumber}-level`).value;
            let moveBsp = document.getElementById(`pkmn${pkmnNumber}-move-bsp-${moveNumber}`).value;

            let atkType = document.getElementById(`pkmn${pkmnNumber}-move-category-${moveNumber}`).value == 'special' ? 'spa' : 'atk';
            let defType = document.getElementById(`pkmn${pkmnNumber}-move-category-${moveNumber}`).value == 'special' ? 'spd' : 'def';

            let atkStat = Number(document.getElementById(`pkmn${pkmnNumber}-${atkType}-calc`).innerText);
            let atkMult = Number(document.getElementById(`pkmn${pkmnNumber}-${atkType}-multiplier`).value);
            atkMult = atkMult == 0 ? 1 : (atkMult > 0 ?  (2 + atkMult) / 2 : 2 / (2 + Math.abs(atkMult)));

            let defStat = Number(document.getElementById(`pkmn${defenderNumber}-${defType}-calc`).innerText);
            let defMult = Number(document.getElementById(`pkmn${defenderNumber}-${defType}-multiplier`).value);
            defMult = defMult == 0 ? 1 : (defMult > 0 ?  (2 + defMult) / 2 : 2 / (2 + Math.abs(defMult)));

            let moveType = document.getElementById(`pkmn${pkmnNumber}-move-type-${moveNumber}-value`).innerText.toLowerCase();
            let defenderType1 = document.getElementById(`pkmn${defenderNumber}-type-1-value`).innerText.toLowerCase();
            if (defenderType1 === '(none)') defenderType1 = '???';
            let defenderType2 = document.getElementById(`pkmn${defenderNumber}-type-2-value`).innerText.toLowerCase();
            if (defenderType2 === '(none)') defenderType2 = '???';

            let typeEff = TYPE_CHART.GEN6[moveType][defenderType1] * TYPE_CHART.GEN6[moveType][defenderType2];


            let pkmnType1 = document.getElementById(`pkmn${pkmnNumber}-type-1-value`).innerText.toLowerCase();
            let pkmnType2 = document.getElementById(`pkmn${pkmnNumber}-type-2-value`).innerText.toLowerCase();
            let isStab = (pkmnType1 == moveType || pkmnType2 == moveType);
            

            let minDamage = calc_damage_gen6plus(attackerLvl, moveBsp, atkStat, atkMult, defStat, defMult, typeEff, isStab, false, 1.0, -1);
            let maxDamage = calc_damage_gen6plus(attackerLvl, moveBsp, atkStat, atkMult, defStat, defMult, typeEff, isStab, false, 1.0, 1);


            console.log('attackerLvl', attackerLvl);
            console.log('moveBsp', moveBsp);
            console.log('atkStat', atkStat);
            console.log('atkMult', atkMult);
            console.log('defStat', defStat);
            console.log('defMult', defMult);
            console.log('typeEff', typeEff);
            console.log('isStab', isStab);
            console.log('-');
            console.log('minDamage', minDamage);
            console.log('maxDamage', maxDamage);
            console.log('-----------------------');
            
            document.getElementById('dmg').innerText = `Damage: ${minDamage} - ${maxDamage}`;
        }

    </script>
</body>

</html>